{% extends 'base.html' %}

{% block title %}Alertas - Sistema de Farmácia{% endblock %}

{% block nav_alerts %}active{% endblock %}

{% block breadcrumb_items %}
<li><a href="{% url 'inventory:alert_list' %}">Alertas</a></li>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="header-content">
        <h1 class="page-title">
            <i class="fas fa-exclamation-triangle"></i>
            Alertas do Sistema
        </h1>
        <div class="alert-stats">
            <div class="stat-item">
                <span class="number">{{ alerts.count }}</span>
                <span class="label">Total de Alertas</span>
            </div>
        </div>
    </div>
</div>

<!-- Filtros -->
<div class="filters-card mb-4">
    <div class="card">
        <div class="card-body">
            <div class="filters-row">
                <select class="form-control" id="alertTypeFilter">
                    <option value="">Todos os tipos</option>
                    <option value="estoque_baixo">Estoque Baixo</option>
                    <option value="vencimento_proximo">Vencimento Próximo</option>
                    <option value="vencido">Vencido</option>
                    <option value="sistema">Sistema</option>
                </select>
                
                <select class="form-control" id="statusFilter">
                    <option value="pending">Pendentes</option>
                    <option value="all">Todos</option>
                    <option value="resolved">Resolvidos</option>
                </select>
                
                <button class="btn btn-outline" onclick="clearFilters()">
                    <i class="fas fa-times"></i>
                    Limpar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Lista de Alertas -->
<div class="content-card">
    <div class="card">
        <div class="card-body">
            {% if alerts %}
                <div class="alerts-list">
                    {% for alert in alerts %}
                    <div class="alert-item {{ alert.alert_type }} {% if alert.is_resolved %}resolved{% endif %}">
                        <div class="alert-icon">
                            {% if alert.alert_type == 'estoque_baixo' %}
                                <i class="fas fa-boxes"></i>
                            {% elif alert.alert_type == 'vencimento_proximo' %}
                                <i class="fas fa-clock"></i>
                            {% elif alert.alert_type == 'vencido' %}
                                <i class="fas fa-calendar-times"></i>
                            {% else %}
                                <i class="fas fa-info-circle"></i>
                            {% endif %}
                        </div>
                        
                        <div class="alert-content">
                            <div class="alert-header">
                                <h4>{{ alert.title }}</h4>
                                <div class="alert-badges">
                                    <span class="alert-type-badge {{ alert.alert_type }}">
                                        {{ alert.get_alert_type_display }}
                                    </span>
                                    {% if alert.is_resolved %}
                                        <span class="status-badge resolved">
                                            <i class="fas fa-check"></i>
                                            Resolvido
                                        </span>
                                    {% else %}
                                        <span class="status-badge pending">
                                            <i class="fas fa-clock"></i>
                                            Pendente
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <p class="alert-message">{{ alert.message }}</p>
                            
                            {% if alert.medication %}
                            <div class="medication-info">
                                <i class="fas fa-pills"></i>
                                <strong>{{ alert.medication.name }}</strong>
                                <span class="category">{{ alert.medication.category.name }}</span>
                            </div>
                            {% endif %}
                            
                            <div class="alert-meta">
                                <div class="meta-item">
                                    <i class="fas fa-calendar"></i>
                                    <span>{{ alert.created_at|date:"d/m/Y H:i" }}</span>
                                </div>
                                {% if alert.is_resolved %}
                                <div class="meta-item">
                                    <i class="fas fa-user"></i>
                                    <span>Resolvido por {{ alert.resolved_by.get_full_name|default:alert.resolved_by.username }}</span>
                                </div>
                                <div class="meta-item">
                                    <i class="fas fa-check-circle"></i>
                                    <span>{{ alert.resolved_at|date:"d/m/Y H:i" }}</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="alert-actions">
                            {% if not alert.is_resolved %}
                                <button class="btn btn-sm btn-success" onclick="resolveAlert({{ alert.pk }})">
                                    <i class="fas fa-check"></i>
                                    Marcar como Resolvido
                                </button>
                            {% endif %}
                            {% if alert.medication %}
                                <a href="{% url 'inventory:medication_detail' alert.medication.pk %}" class="btn btn-sm btn-outline">
                                    <i class="fas fa-eye"></i>
                                    Ver Medicamento
                                </a>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-check-circle"></i>
                    <h3>Nenhum alerta encontrado</h3>
                    <p>Ótimo! Não há alertas pendentes no momento.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.alert-stats {
    display: flex;
    gap: 2rem;
}

.stat-item {
    text-align: center;
}

.stat-item .number {
    display: block;
    font-size: 2rem;
    font-weight: 700;
    color: var(--primary-color);
}

.stat-item .label {
    font-size: 0.875rem;
    color: var(--gray-600);
}

.filters-row {
    display: flex;
    gap: 1rem;
    align-items: center;
}

.alerts-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.alert-item {
    background: white;
    border: 1px solid var(--gray-200);
    border-left-width: 4px;
    border-radius: 8px;
    padding: 1.5rem;
    display: flex;
    gap: 1rem;
    transition: all 0.3s ease;
}

.alert-item:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.alert-item.estoque_baixo {
    border-left-color: var(--info-color);
}

.alert-item.vencimento_proximo {
    border-left-color: var(--warning-color);
}

.alert-item.vencido {
    border-left-color: var(--danger-color);
}

.alert-item.sistema {
    border-left-color: var(--primary-color);
}

.alert-item.resolved {
    opacity: 0.7;
    background: var(--gray-50);
}

.alert-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    color: white;
    flex-shrink: 0;
}

.alert-item.estoque_baixo .alert-icon {
    background: var(--info-color);
}

.alert-item.vencimento_proximo .alert-icon {
    background: var(--warning-color);
}

.alert-item.vencido .alert-icon {
    background: var(--danger-color);
}

.alert-item.sistema .alert-icon {
    background: var(--primary-color);
}

.alert-content {
    flex: 1;
}

.alert-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.5rem;
}

.alert-header h4 {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--gray-900);
    margin: 0;
}

.alert-badges {
    display: flex;
    gap: 0.5rem;
}

.alert-type-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
}

.alert-type-badge.estoque_baixo {
    background: rgba(6, 182, 212, 0.1);
    color: var(--info-color);
}

.alert-type-badge.vencimento_proximo {
    background: rgba(245, 158, 11, 0.1);
    color: var(--warning-color);
}

.alert-type-badge.vencido {
    background: rgba(239, 68, 68, 0.1);
    color: var(--danger-color);
}

.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
}

.status-badge.pending {
    background: rgba(245, 158, 11, 0.1);
    color: var(--warning-color);
}

.status-badge.resolved {
    background: rgba(34, 197, 94, 0.1);
    color: var(--success-color);
}

.alert-message {
    color: var(--gray-700);
    margin: 0.5rem 0;
}

.medication-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem;
    background: var(--gray-50);
    border-radius: 6px;
    margin: 0.5rem 0;
}

.medication-info i {
    color: var(--primary-color);
}

.medication-info .category {
    color: var(--gray-500);
    font-size: 0.875rem;
}

.alert-meta {
    display: flex;
    gap: 1rem;
    margin-top: 1rem;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.75rem;
    color: var(--gray-500);
}

.alert-actions {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    align-items: flex-end;
}

@media (max-width: 768px) {
    .alert-item {
        flex-direction: column;
    }
    
    .alert-header {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .alert-actions {
        flex-direction: row;
        align-items: center;
    }
    
    .filters-row {
        flex-direction: column;
        align-items: stretch;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function resolveAlert(alertId) {
    if (confirm('Tem certeza que deseja marcar este alerta como resolvido?')) {
        fetch(`/inventory/alerts/${alertId}/resolve/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': PharmacySystem.getCsrfToken(),
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('Erro ao resolver alerta');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erro ao resolver alerta');
        });
    }
}

function clearFilters() {
    document.getElementById('alertTypeFilter').value = '';
    document.getElementById('statusFilter').value = 'pending';
    // Aplicar filtros...
}
</script>
{% endblock %}
