{% extends 'base.html' %}

{% block title %}Integridade do Sistema - Sistema de Farmácia{% endblock %}

{% block nav_dashboard %}active{% endblock %}

{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/modern-dashboard.css' %}">
<link rel="stylesheet" href="{% static 'css/dark-theme.css' %}">
{% endblock %}

{% block breadcrumb_items %}
<li><a href="{% url 'core:dashboard' %}">Dashboard</a></li>
<li>Integridade do Sistema</li>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Page Header -->
    <div class="modern-page-header animate-fade-in-up">
        <div class="header-content">
            <h1 class="page-title">
                <i class="fas fa-shield-alt"></i>
                Integridade do Sistema
                <span class="subtitle">Verificação da consistência dos dados</span>
            </h1>
            <div class="header-actions">
                <a href="{% url 'core:consistency_report' %}" class="btn-modern btn-primary">
                    <i class="fas fa-clipboard-check"></i>
                    Relatório Completo
                </a>
                <a href="{% url 'core:dashboard' %}" class="btn-modern btn-outline">
                    <i class="fas fa-arrow-left"></i>
                    Voltar ao Dashboard
                </a>
            </div>
        </div>
    </div>

    <!-- Status Geral -->
    <div class="alert-banner animate-fade-in-up">
        {% if system_health == 'healthy' %}
        <div class="alert-item success">
            <i class="fas fa-check-circle"></i>
            <div>
                <h4>Sistema Íntegro</h4>
                <p>Todos os dados estão consistentes e sem problemas detectados</p>
            </div>
        </div>
        {% else %}
        <div class="alert-item warning">
            <i class="fas fa-exclamation-triangle"></i>
            <div>
                <h4>Problemas Detectados</h4>
                <p>{{ issues|length }} problema(s) encontrado(s) que requerem atenção</p>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Métricas de Integridade -->
    <div class="metrics-grid animate-fade-in-up">
        <div class="metric-card branches">
            <div class="metric-header">
                <div class="metric-icon">
                    <i class="fas fa-cubes"></i>
                </div>
            </div>
            <div class="metric-value">{{ total_batches }}</div>
            <div class="metric-label">Total de Lotes</div>
        </div>
        
        <div class="metric-card medications">
            <div class="metric-header">
                <div class="metric-icon">
                    <i class="fas fa-map-marker-alt"></i>
                </div>
            </div>
            <div class="metric-value">{{ total_locations }}</div>
            <div class="metric-label">Localizações Ativas</div>
        </div>
        
        <div class="metric-card alerts">
            <div class="metric-header">
                <div class="metric-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
            </div>
            <div class="metric-value">{{ orphan_batches }}</div>
            <div class="metric-label">Lotes Órfãos</div>
        </div>
        
        <div class="metric-card transfers {% if invalid_locations > 0 %}danger{% else %}success{% endif %}">
            <div class="metric-header">
                <div class="metric-icon">
                    <i class="fas fa-times-circle"></i>
                </div>
            </div>
            <div class="metric-value">{{ invalid_locations }}</div>
            <div class="metric-label">Reservas Inválidas</div>
        </div>
    </div>

    <!-- Detalhes dos Problemas -->
    {% if issues %}
    <div class="content-card">
        <div class="card-header">
            <h3><i class="fas fa-exclamation-triangle"></i> Problemas Detectados</h3>
        </div>
        <div class="card-body">
            <div class="issues-list">
                {% for issue in issues %}
                <div class="issue-item">
                    <div class="issue-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="issue-content">
                        <h4>{{ issue }}</h4>
                        <p>Este problema pode afetar a consistência dos dados do sistema.</p>
                    </div>
                    <div class="issue-action">
                        <a href="{% url 'core:consistency_report' %}" class="btn btn-sm btn-outline-primary">
                            Ver Detalhes
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Verificações de Integridade -->
    <div class="content-card">
        <div class="card-header">
            <h3><i class="fas fa-clipboard-list"></i> Verificações Realizadas</h3>
        </div>
        <div class="card-body">
            <div class="checks-grid">
                <div class="check-item {% if orphan_batches == 0 %}success{% else %}error{% endif %}">
                    <div class="check-icon">
                        {% if orphan_batches == 0 %}
                        <i class="fas fa-check-circle"></i>
                        {% else %}
                        <i class="fas fa-times-circle"></i>
                        {% endif %}
                    </div>
                    <div class="check-content">
                        <h4>Lotes sem Localização</h4>
                        <p>Verificação de lotes órfãos no sistema</p>
                        <div class="check-result">
                            {% if orphan_batches == 0 %}
                            <span class="success">✓ Nenhum lote órfão encontrado</span>
                            {% else %}
                            <span class="error">✗ {{ orphan_batches }} lote(s) sem localização</span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="check-item {% if invalid_locations == 0 %}success{% else %}error{% endif %}">
                    <div class="check-icon">
                        {% if invalid_locations == 0 %}
                        <i class="fas fa-check-circle"></i>
                        {% else %}
                        <i class="fas fa-times-circle"></i>
                        {% endif %}
                    </div>
                    <div class="check-content">
                        <h4>Reservas de Estoque</h4>
                        <p>Validação de quantidades reservadas</p>
                        <div class="check-result">
                            {% if invalid_locations == 0 %}
                            <span class="success">✓ Todas as reservas são válidas</span>
                            {% else %}
                            <span class="error">✗ {{ invalid_locations }} reserva(s) inválida(s)</span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="check-item success">
                    <div class="check-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="check-content">
                        <h4>Estrutura de Dados</h4>
                        <p>Integridade das tabelas e relacionamentos</p>
                        <div class="check-result">
                            <span class="success">✓ Estrutura consistente</span>
                        </div>
                    </div>
                </div>

                <div class="check-item success">
                    <div class="check-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="check-content">
                        <h4>Fonte Única de Verdade</h4>
                        <p>Verificação do sistema unificado</p>
                        <div class="check-result">
                            <span class="success">✓ Sistema unificado operacional</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ações Recomendadas -->
    {% if system_health != 'healthy' %}
    <div class="content-card">
        <div class="card-header">
            <h3><i class="fas fa-tools"></i> Ações Recomendadas</h3>
        </div>
        <div class="card-body">
            <div class="recommendations">
                <div class="recommendation-item">
                    <div class="recommendation-icon">
                        <i class="fas fa-clipboard-check"></i>
                    </div>
                    <div class="recommendation-content">
                        <h4>Executar Relatório Completo</h4>
                        <p>Execute o relatório de consistência completo para obter detalhes específicos sobre cada problema.</p>
                        <a href="{% url 'core:consistency_report' %}" class="btn btn-sm btn-primary">
                            Executar Relatório
                        </a>
                    </div>
                </div>

                {% if orphan_batches > 0 %}
                <div class="recommendation-item">
                    <div class="recommendation-icon">
                        <i class="fas fa-database"></i>
                    </div>
                    <div class="recommendation-content">
                        <h4>Corrigir Lotes Órfãos</h4>
                        <p>Revisar e corrigir lotes que não possuem localização definida no sistema.</p>
                    </div>
                </div>
                {% endif %}

                {% if invalid_locations > 0 %}
                <div class="recommendation-item">
                    <div class="recommendation-icon">
                        <i class="fas fa-balance-scale"></i>
                    </div>
                    <div class="recommendation-content">
                        <h4>Ajustar Reservas</h4>
                        <p>Corrigir quantidades reservadas que excedem o estoque disponível.</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<style>
/* Estilos específicos para integridade do sistema */
.subtitle {
    font-size: 0.875rem;
    font-weight: 400;
    opacity: 0.8;
    margin-left: 1rem;
}

.alert-item.success {
    background: rgba(16, 185, 129, 0.1);
    border-left-color: #10B981;
    color: #065F46;
}

.metric-card.danger {
    background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
}

.metric-card.success {
    background: linear-gradient(135deg, #10B981 0%, #059669 100%);
}

.issues-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.issue-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: rgba(245, 158, 11, 0.1);
    border-left: 4px solid #F59E0B;
    border-radius: var(--radius-md);
}

.issue-icon i {
    font-size: 1.5rem;
    color: #F59E0B;
}

.issue-content {
    flex: 1;
}

.issue-content h4 {
    margin: 0 0 0.25rem 0;
    font-size: 1rem;
    font-weight: 600;
    color: var(--neutral-900);
}

.issue-content p {
    margin: 0;
    font-size: 0.875rem;
    color: var(--neutral-600);
}

.checks-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
}

.check-item {
    display: flex;
    gap: 1rem;
    padding: 1.5rem;
    background: white;
    border: 1px solid var(--neutral-200);
    border-radius: var(--radius-lg);
    border-left: 4px solid;
}

.check-item.success {
    border-left-color: #10B981;
}

.check-item.error {
    border-left-color: #EF4444;
}

.check-icon i {
    font-size: 1.5rem;
}

.check-item.success .check-icon i {
    color: #10B981;
}

.check-item.error .check-icon i {
    color: #EF4444;
}

.check-content h4 {
    margin: 0 0 0.5rem 0;
    font-size: 1rem;
    font-weight: 600;
    color: var(--neutral-900);
}

.check-content p {
    margin: 0 0 0.75rem 0;
    font-size: 0.875rem;
    color: var(--neutral-600);
}

.check-result .success {
    color: #10B981;
    font-weight: 600;
}

.check-result .error {
    color: #EF4444;
    font-weight: 600;
}

.recommendations {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.recommendation-item {
    display: flex;
    gap: 1rem;
    padding: 1.5rem;
    background: var(--neutral-50);
    border-radius: var(--radius-lg);
}

.recommendation-icon {
    flex-shrink: 0;
    width: 3rem;
    height: 3rem;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--primary-blue);
    color: white;
    border-radius: var(--radius-full);
}

.recommendation-content h4 {
    margin: 0 0 0.5rem 0;
    font-size: 1rem;
    font-weight: 600;
    color: var(--neutral-900);
}

.recommendation-content p {
    margin: 0 0 1rem 0;
    font-size: 0.875rem;
    color: var(--neutral-600);
}
</style>
{% endblock %}
