{% extends 'base.html' %}

{% block title %}Transferência #{{ transfer.pk }} - Sistema de Farmácia{% endblock %}

{% block nav_branches %}active{% endblock %}

{% block breadcrumb_items %}
<li><a href="{% url 'branches:dashboard' %}">Filiais</a></li>
<li>Transferência #{{ transfer.pk }}</li>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="header-content">
        <h1 class="page-title">
            <i class="fas fa-exchange-alt"></i>
            Transferência #{{ transfer.pk }}
            <span class="status-badge status-{{ transfer.status }}">
                {{ transfer.get_status_display }}
            </span>
        </h1>
        <div class="header-actions">
            {% if transfer.status == 'pending' and is_admin %}
            <button onclick="approveTransfer()" class="btn btn-success">
                <i class="fas fa-check"></i>
                Aprovar Transferência
            </button>
            {% endif %}
            <a href="{% url 'branches:dashboard' %}" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left"></i>
                Voltar
            </a>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Detalhes da Transferência -->
    <div class="content-card">
        <div class="card">
            <div class="card-header">
                <h3><i class="fas fa-info-circle"></i> Detalhes da Transferência</h3>
            </div>
            <div class="card-body">
                <div class="transfer-details">
                    <div class="detail-group">
                        <h4><i class="fas fa-pills"></i> Medicamento</h4>
                        <div class="medication-info">
                            <h5>{{ transfer.medication.name }}</h5>
                            <p>{{ transfer.medication.dosage }} - {{ transfer.medication.pharmaceutical_form }}</p>
                            <span class="category">{{ transfer.medication.category.name }}</span>
                        </div>
                    </div>
                    
                    <div class="detail-row">
                        <div class="detail-item">
                            <label><i class="fas fa-boxes"></i> Quantidade:</label>
                            <span class="quantity">{{ transfer.quantity }} unidades</span>
                        </div>
                        
                        <div class="detail-item">
                            <label><i class="fas fa-calendar"></i> Solicitado em:</label>
                            <span>{{ transfer.requested_at|date:"d/m/Y H:i" }}</span>
                        </div>
                    </div>
                    
                    <div class="detail-item">
                        <label><i class="fas fa-user"></i> Solicitado por:</label>
                        <span>{{ transfer.requested_by.get_full_name|default:transfer.requested_by.username }}</span>
                    </div>
                    
                    {% if transfer.approved_by %}
                    <div class="detail-item">
                        <label><i class="fas fa-user-check"></i> Aprovado por:</label>
                        <span>{{ transfer.approved_by.get_full_name|default:transfer.approved_by.username }}</span>
                    </div>
                    {% endif %}
                    
                    {% if transfer.completed_at %}
                    <div class="detail-item">
                        <label><i class="fas fa-calendar-check"></i> Concluído em:</label>
                        <span>{{ transfer.completed_at|date:"d/m/Y H:i" }}</span>
                    </div>
                    {% endif %}
                </div>
                
                <div class="reason-section">
                    <h4><i class="fas fa-comment"></i> Motivo</h4>
                    <p class="reason-text">{{ transfer.reason }}</p>
                </div>
                
                {% if transfer.notes %}
                <div class="notes-section">
                    <h4><i class="fas fa-sticky-note"></i> Observações</h4>
                    <p class="notes-text">{{ transfer.notes }}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Filiais Envolvidas -->
    <div class="content-card">
        <div class="card">
            <div class="card-header">
                <h3><i class="fas fa-building"></i> Filiais Envolvidas</h3>
            </div>
            <div class="card-body">
                <div class="transfer-flow">
                    <!-- Filial Origem -->
                    <div class="branch-card origin">
                        <div class="branch-header">
                            <h4>{{ transfer.from_branch.name }}</h4>
                            <span class="branch-code">{{ transfer.from_branch.code }}</span>
                        </div>
                        <div class="branch-info">
                            <p><i class="fas fa-map-marker-alt"></i> {{ transfer.from_branch.address|truncatechars:50 }}</p>
                            <p><i class="fas fa-phone"></i> {{ transfer.from_branch.phone }}</p>
                            {% if transfer.from_branch.manager %}
                            <p><i class="fas fa-user"></i> {{ transfer.from_branch.manager.get_full_name|default:transfer.from_branch.manager.username }}</p>
                            {% endif %}
                        </div>
                        <div class="branch-role">
                            <span class="role-badge origin">Origem</span>
                        </div>
                        {% if from_stock %}
                        <div class="stock-info" id="from-stock-info" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e0e0e0;">
                            <p><strong>Estoque Atual:</strong> {{ from_stock.quantity }} unidades</p>
                            <p><strong>Disponível:</strong> {{ from_stock.available_quantity }} unidades</p>
                            <p><strong>Reservado:</strong> {{ from_stock.reserved_quantity }} unidades</p>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Seta de Transferência -->
                    <div class="transfer-arrow">
                        <i class="fas fa-arrow-right"></i>
                        <span class="transfer-status">{{ transfer.get_status_display }}</span>
                    </div>
                    
                    <!-- Filial Destino -->
                    <div class="branch-card destination">
                        <div class="branch-header">
                            <h4>{{ transfer.to_branch.name }}</h4>
                            <span class="branch-code">{{ transfer.to_branch.code }}</span>
                        </div>
                        <div class="branch-info">
                            <p><i class="fas fa-map-marker-alt"></i> {{ transfer.to_branch.address|truncatechars:50 }}</p>
                            <p><i class="fas fa-phone"></i> {{ transfer.to_branch.phone }}</p>
                            {% if transfer.to_branch.manager %}
                            <p><i class="fas fa-user"></i> {{ transfer.to_branch.manager.get_full_name|default:transfer.to_branch.manager.username }}</p>
                            {% endif %}
                        </div>
                        <div class="branch-role">
                            <span class="role-badge destination">Destino</span>
                        </div>
                        {% if to_stock %}
                        <div class="stock-info" id="to-stock-info">
                            <p><strong>Estoque Atual:</strong> {{ to_stock.quantity }} unidades</p>
                            <p><strong>Disponível:</strong> {{ to_stock.available_quantity }} unidades</p>
                            <p><strong>Reservado:</strong> {{ to_stock.reserved_quantity }} unidades</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Timeline do Processo -->
<div class="content-card mt-6">
    <div class="card">
        <div class="card-header">
            <h3><i class="fas fa-history"></i> Timeline do Processo</h3>
        </div>
        <div class="card-body">
            <div class="timeline">
                <div class="timeline-item completed">
                    <div class="timeline-marker">
                        <i class="fas fa-paper-plane"></i>
                    </div>
                    <div class="timeline-content">
                        <h4>Solicitação Criada</h4>
                        <p>{{ transfer.requested_at|date:"d/m/Y H:i" }} por {{ transfer.requested_by.get_full_name|default:transfer.requested_by.username }}</p>
                    </div>
                </div>
                
                {% if transfer.status != 'pending' %}
                <div class="timeline-item completed">
                    <div class="timeline-marker">
                        <i class="fas fa-check"></i>
                    </div>
                    <div class="timeline-content">
                        <h4>Transferência Aprovada</h4>
                        <p>{{ transfer.completed_at|date:"d/m/Y H:i" }} por {{ transfer.approved_by.get_full_name|default:transfer.approved_by.username }}</p>
                    </div>
                </div>
                {% endif %}
                
                {% if transfer.status == 'completed' %}
                <div class="timeline-item completed">
                    <div class="timeline-marker">
                        <i class="fas fa-flag-checkered"></i>
                    </div>
                    <div class="timeline-content">
                        <h4>Transferência Concluída</h4>
                        <p>Estoques atualizados automaticamente</p>
                    </div>
                </div>
                {% elif transfer.status == 'pending' %}
                <div class="timeline-item pending">
                    <div class="timeline-marker">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="timeline-content">
                        <h4>Aguardando Aprovação</h4>
                        <p>Transferência pendente de aprovação do administrador</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
.status-badge {
    padding: 0.5rem 1rem;
    border-radius: var(--border-radius-full);
    font-size: 0.875rem;
    font-weight: 600;
    text-transform: uppercase;
    margin-left: 1rem;
}

.status-pending {
    background: var(--warning-color);
    color: white;
}

.status-completed {
    background: var(--success-color);
    color: white;
}

.status-in_transit {
    background: var(--info-color);
    color: white;
}

.status-cancelled {
    background: var(--danger-color);
    color: white;
}

.transfer-details {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.detail-group h4,
.reason-section h4,
.notes-section h4 {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
    color: var(--gray-700);
    font-size: 1rem;
}

.medication-info h5 {
    margin: 0 0 0.5rem 0;
    font-size: 1.125rem;
    color: var(--gray-900);
}

.medication-info p {
    margin: 0 0 0.5rem 0;
    color: var(--gray-600);
}

.category {
    background: var(--gray-100);
    color: var(--gray-700);
    padding: 0.25rem 0.5rem;
    border-radius: var(--border-radius);
    font-size: 0.75rem;
    font-weight: 500;
}

.detail-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.detail-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.detail-item label {
    font-weight: 600;
    color: var(--gray-700);
    font-size: 0.875rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.quantity {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--primary-color);
}

.reason-text,
.notes-text {
    background: var(--gray-50);
    padding: 1rem;
    border-radius: var(--border-radius);
    border-left: 4px solid var(--primary-color);
    margin: 0;
    line-height: 1.6;
}

.transfer-flow {
    display: flex;
    flex-direction: column;
    gap: 2rem;
    align-items: center;
}

.branch-card {
    background: var(--gray-50);
    border: 1px solid var(--gray-200);
    border-radius: var(--border-radius-lg);
    padding: 1.5rem;
    width: 100%;
    position: relative;
}

.branch-card.origin {
    border-left: 4px solid var(--info-color);
}

.branch-card.destination {
    border-left: 4px solid var(--success-color);
}

.branch-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.branch-header h4 {
    margin: 0;
    color: var(--gray-900);
}

.branch-code {
    background: var(--gray-700);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: var(--border-radius);
    font-size: 0.75rem;
    font-weight: 600;
}

.branch-info p {
    margin: 0 0 0.5rem 0;
    font-size: 0.875rem;
    color: var(--gray-600);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.role-badge {
    position: absolute;
    top: -10px;
    right: 1rem;
    padding: 0.25rem 0.75rem;
    border-radius: var(--border-radius-full);
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.role-badge.origin {
    background: var(--info-color);
    color: white;
}

.role-badge.destination {
    background: var(--success-color);
    color: white;
}

.transfer-arrow {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    color: var(--gray-400);
    font-size: 2rem;
}

.transfer-status {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--gray-600);
}

.timeline {
    display: flex;
    flex-direction: column;
    gap: 2rem;
}

.timeline-item {
    display: flex;
    gap: 1rem;
    align-items: flex-start;
}

.timeline-marker {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    flex-shrink: 0;
}

.timeline-item.completed .timeline-marker {
    background: var(--success-color);
    color: white;
}

.timeline-item.pending .timeline-marker {
    background: var(--warning-color);
    color: white;
}

.timeline-content h4 {
    margin: 0 0 0.5rem 0;
    color: var(--gray-900);
}

.timeline-content p {
    margin: 0;
    color: var(--gray-600);
    font-size: 0.875rem;
}

@media (max-width: 768px) {
    .detail-row {
        grid-template-columns: 1fr;
    }
    
    .transfer-flow {
        gap: 1rem;
    }
    
    .transfer-arrow {
        transform: rotate(90deg);
    }
}
</style>

{% if transfer.status == 'pending' and is_admin %}
<script>
function approveTransfer() {
    if (confirm('Tem certeza que deseja aprovar esta transferência? Esta ação não pode ser desfeita.')) {
        // Criar formulário para submeter aprovação
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{% url "branches:approve_transfer" transfer.pk %}';
        
        // Adicionar CSRF token
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = '{{ csrf_token }}';
        form.appendChild(csrfInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}

// Sincronizar estoque após aprovação
function syncStock(branchPk, medicationPk, elementId) {
    fetch(`{% url "branches:api_stock_sync" 0 0 %}`.replace('0/0', branchPk + '/' + medicationPk))
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = `Quantidade: ${data.quantity} | Disponível: ${data.available_quantity}`;
                }
            }
        })
        .catch(error => console.error('Erro ao sincronizar estoque:', error));
}

// Sincronizar estoques quando a página carregar (se transferência foi concluída)
{% if transfer.status == 'completed' and from_stock and to_stock %}
document.addEventListener('DOMContentLoaded', function() {
    // Atualizar informações de estoque
    syncStock({{ transfer.from_branch.pk }}, {{ transfer.medication.pk }}, 'from-stock-info');
    syncStock({{ transfer.to_branch.pk }}, {{ transfer.medication.pk }}, 'to-stock-info');
});
{% endif %}
</script>
{% endif %}
{% endblock %}
