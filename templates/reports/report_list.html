{% extends 'base.html' %}

{% block title %}Relatórios - Sistema de Farmácia{% endblock %}

{% block nav_reports %}active{% endblock %}

{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/modern-dashboard.css' %}">
<link rel="stylesheet" href="{% static 'css/dark-theme.css' %}">
<style>
/* Estilos específicos para relatórios modernos */
.reports-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem 0;
    margin-bottom: 2rem;
    border-radius: var(--radius-lg);
}

.reports-header .header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1.5rem;
}

.reports-header h1 {
    font-size: 2.5rem;
    font-weight: 700;
    margin: 0 0 0.5rem 0;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.reports-header .subtitle {
    font-size: 1.1rem;
    opacity: 0.9;
    margin: 0;
}

.status-indicator {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: rgba(255, 255, 255, 0.2);
    border-radius: var(--radius-full);
    font-size: 0.875rem;
}

.status-indicator.online {
    background: rgba(16, 185, 129, 0.2);
}

.status-indicator.offline {
    background: rgba(239, 68, 68, 0.2);
}

.reports-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.report-card {
    background: white;
    border-radius: var(--radius-lg);
    padding: 2rem;
    box-shadow: var(--shadow-md);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    border: 1px solid var(--neutral-200);
}

.report-card::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 100px;
    height: 100px;
    background: linear-gradient(45deg, transparent 60%, rgba(255,255,255,0.1));
    transform: translateX(50%) translateY(-50%) rotate(45deg);
}

.report-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
}

.report-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.report-icon {
    width: 4rem;
    height: 4rem;
    border-radius: var(--radius-full);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: white;
    flex-shrink: 0;
}

.report-icon.stock { background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%); }
.report-icon.movements { background: linear-gradient(135deg, #10B981 0%, #059669 100%); }
.report-icon.expiration { background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%); }

.report-info h3 {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--neutral-900);
    margin: 0;
}

.report-description {
    color: var(--neutral-600);
    font-size: 0.875rem;
    margin: 0.5rem 0 1.5rem 0;
    line-height: 1.5;
}

.report-actions {
    display: flex;
    gap: 0.75rem;
    margin-top: auto;
}

.btn-generate {
    flex: 1;
    background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%);
    color: white;
    border: none;
    padding: 0.75rem 1rem;
    border-radius: var(--radius-md);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.btn-generate:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
}

.btn-generate:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.btn-generate.loading {
    color: transparent;
}

.btn-generate .loading-spinner {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 1rem;
    height: 1rem;
    border: 2px solid transparent;
    border-top: 2px solid white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    display: none;
}

.btn-generate.loading .loading-spinner {
    display: block;
}

@keyframes spin {
    0% { transform: translate(-50%, -50%) rotate(0deg); }
    100% { transform: translate(-50%, -50%) rotate(360deg); }
}

.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 1rem 1.5rem;
    border-radius: var(--radius-md);
    color: white;
    font-weight: 600;
    z-index: 1000;
    transform: translateX(100%);
    transition: transform 0.3s ease;
}

.notification.show {
    transform: translateX(0);
}

.notification.success {
    background: linear-gradient(135deg, #10B981 0%, #059669 100%);
}

.notification.error {
    background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
}

.history-section {
    background: white;
    border-radius: var(--radius-lg);
    overflow: hidden;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--neutral-200);
}

.section-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--neutral-200);
    background: var(--neutral-50);
}

.section-header h2 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--neutral-900);
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

@media (max-width: 768px) {
    .reports-header .header-content {
        flex-direction: column;
        text-align: center;
        gap: 1rem;
    }
    
    .reports-grid {
        grid-template-columns: 1fr;
    }
    
    .report-actions {
        flex-direction: column;
    }
}
</style>
{% endblock %}

{% block breadcrumb_items %}
<li><a href="{% url 'reports:report_list' %}">Relatórios</a></li>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Header Moderno -->
    <div class="reports-header animate-fade-in-up">
        <div class="header-content">
            <div>
                <h1>
                    <i class="fas fa-chart-bar"></i>
                    Sistema de Relatórios
                </h1>
                <p class="subtitle">Gere relatórios detalhados em PDF com dados consolidados</p>
            </div>
            <div class="status-indicator online" id="pdf-status">
                <div class="status-dot"></div>
                <span>Sistema Online</span>
            </div>
        </div>
    </div>

    <!-- Cards de Relatórios -->
    <div class="reports-grid animate-fade-in-up">
        <div class="report-card">
            <div class="report-header">
                <div class="report-icon stock">
                    <i class="fas fa-boxes"></i>
                </div>
                <div class="report-info">
                    <h3>Relatório de Estoque</h3>
                </div>
            </div>
            <p class="report-description">
                Situação completa de todos os medicamentos em estoque com métricas consolidadas, 
                status de vencimento e alertas de estoque baixo.
            </p>
            <div class="report-actions">
                <button class="btn-generate" id="btn-stock">
                    <i class="fas fa-file-pdf"></i>
                    Gerar Relatório de Estoque
                    <span class="loading-spinner"></span>
                </button>
            </div>
        </div>
        
        <div class="report-card">
            <div class="report-header">
                <div class="report-icon movements">
                    <i class="fas fa-exchange-alt"></i>
                </div>
                <div class="report-info">
                    <h3>Relatório de Movimentações</h3>
                </div>
            </div>
            <p class="report-description">
                Histórico detalhado de todas as transferências e movimentações 
                dos últimos 30 dias entre filiais e estoque geral.
            </p>
            <div class="report-actions">
                <button class="btn-generate" id="btn-movements">
                    <i class="fas fa-file-pdf"></i>
                    Gerar Relatório de Movimentações
                    <span class="loading-spinner"></span>
                </button>
            </div>
        </div>
        
        <div class="report-card">
            <div class="report-header">
                <div class="report-icon expiration">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="report-info">
                    <h3>Relatório de Vencimentos</h3>
                </div>
            </div>
            <p class="report-description">
                Análise completa de lotes vencidos e próximos ao vencimento, 
                com recomendações e níveis de urgência para ação.
            </p>
            <div class="report-actions">
                <button class="btn-generate" id="btn-expiration">
                    <i class="fas fa-file-pdf"></i>
                    Gerar Relatório de Vencimentos
                    <span class="loading-spinner"></span>
                </button>
            </div>
        </div>
    </div>

<!-- Histórico de Relatórios -->
<div class="content-card">
    <div class="card">
        <div class="card-header">
            <h3>Histórico de Relatórios</h3>
        </div>
        
        <div class="card-body">
            {% if reports %}
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Título</th>
                                <th>Tipo</th>
                                <th>Gerado por</th>
                                <th>Data</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for report in reports %}
                            <tr>
                                <td>
                                    <strong>{{ report.title }}</strong>
                                    <small class="d-block">{{ report.description|default:"" }}</small>
                                </td>
                                <td>
                                    <span class="report-type {{ report.report_type }}">
                                        {% if report.report_type == 'estoque' %}
                                            <i class="fas fa-boxes"></i>
                                            Estoque
                                        {% elif report.report_type == 'movimentacao' %}
                                            <i class="fas fa-exchange-alt"></i>
                                            Movimentação
                                        {% elif report.report_type == 'vencimento' %}
                                            <i class="fas fa-calendar-times"></i>
                                            Vencimento
                                        {% else %}
                                            {{ report.get_report_type_display }}
                                        {% endif %}
                                    </span>
                                </td>
                                <td>{{ report.generated_by.get_full_name|default:report.generated_by.username }}</td>
                                <td>{{ report.created_at|date:"d/m/Y H:i" }}</td>
                                <td>
                                    <div class="action-buttons">
                                        <a href="{% url 'reports:report_detail' report.pk %}" class="btn btn-sm btn-outline">
                                            <i class="fas fa-eye"></i>
                                            Ver
                                        </a>
                                        {% if report.file_path %}
                                        <a href="{% url 'reports:report_download' report.pk %}" class="btn btn-sm btn-primary">
                                            <i class="fas fa-download"></i>
                                            Download
                                        </a>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-chart-bar"></i>
                    <h3>Nenhum relatório gerado</h3>
                    <p>Comece gerando seu primeiro relatório usando as opções acima.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
    <!-- Histórico de Relatórios -->
    <div class="history-section animate-fade-in-up">
        <div class="section-header">
            <h2>
                <i class="fas fa-history"></i>
                Histórico de Relatórios
            </h2>
        </div>
        
        <div class="card-body">
            {% if reports %}
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Título</th>
                                <th>Tipo</th>
                                <th>Gerado por</th>
                                <th>Data</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for report in reports %}
                            <tr>
                                <td>
                                    <strong>{{ report.title }}</strong>
                                    <small class="d-block">{{ report.description|default:"" }}</small>
                                </td>
                                <td>
                                    <span class="report-type {{ report.report_type }}">
                                        {% if report.report_type == 'stock' %}
                                            <i class="fas fa-boxes"></i>
                                            Estoque
                                        {% elif report.report_type == 'movements' %}
                                            <i class="fas fa-exchange-alt"></i>
                                            Movimentação
                                        {% elif report.report_type == 'expiration' %}
                                            <i class="fas fa-calendar-times"></i>
                                            Vencimento
                                        {% else %}
                                            {{ report.get_report_type_display }}
                                        {% endif %}
                                    </span>
                                </td>
                                <td>{{ report.generated_by.get_full_name|default:report.generated_by.username }}</td>
                                <td>{{ report.created_at|date:"d/m/Y H:i" }}</td>
                                <td>
                                    <div class="action-buttons">
                                        <a href="{% url 'reports:report_detail' report.pk %}" class="btn btn-sm btn-outline">
                                            <i class="fas fa-eye"></i>
                                            Ver
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-chart-bar"></i>
                    <h3>Nenhum relatório gerado</h3>
                    <p>Comece gerando seu primeiro relatório usando as opções acima.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Container para notificações -->
<div id="notification-container"></div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/modern-dashboard.js' %}?v=20251114"></script>
<script>
// Substituir método de geração por abrir PDF em nova aba
function openReport(type) {
    const endpoints = {
        stock: "{% url 'reports:stock_report_pdf' %}",
        movements: "{% url 'reports:movements_report_pdf' %}",
        expiration: "{% url 'reports:expiration_report_pdf' %}"
    };
    const url = endpoints[type];
    if (!url) {
        console.error('Tipo de relatório inválido:', type);
        return;
    }
    // Abrir em nova aba - o servidor deve responder com application/pdf
    window.open(url, '_blank');
}

// Ajustar handlers dos botões
document.addEventListener('DOMContentLoaded', function() {
    ['stock','movements','expiration'].forEach(function(type){
        const btn = document.getElementById(`btn-${type}`);
        if (btn) {
            btn.onclick = function(e) {
                e.preventDefault();
                openReport(type);
            };
        }
    });

    // Inicializar DashboardModerno se disponível
    if (typeof DashboardModerno !== 'undefined' && DashboardModerno && typeof DashboardModerno.init === 'function') {
        try { DashboardModerno.init(); } catch(e) { console.warn('Falha ao inicializar DashboardModerno:', e); }
    }
});
</script>
{% endblock %}
