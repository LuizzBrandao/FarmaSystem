<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
</head>
<body>
    <div class="header">
        <h1>{{ company_name }}</h1>
        <h2>{{ title }}</h2>
        <div class="meta">
            <p>Data de referência: {{ today|date:"d/m/Y" }}</p>
            <p>Limite próximo vencimento: {{ thirty_days_limit|date:"d/m/Y" }}</p>
            <p>Gerado em: {{ generated_at|date:"d/m/Y H:i:s" }}</p>
            <p>Por: {{ user.get_full_name|default:user.username }}</p>
        </div>
    </div>
    
    <div class="metrics-grid">
        <div class="metric-card">
            <h3>Lotes Vencidos</h3>
            <p class="value">{{ vencimentos.expired_count }}</p>
        </div>
        <div class="metric-card">
            <h3>Próximo Vencimento</h3>
            <p class="value">{{ vencimentos.near_expiry_count }}</p>
        </div>
        <div class="metric-card">
            <h3>Quantidade Vencida</h3>
            <p class="value">{{ vencimentos.total_expired_quantity }}</p>
        </div>
        <div class="metric-card">
            <h3>Quantidade Próxima</h3>
            <p class="value">{{ vencimentos.total_near_expiry_quantity }}</p>
        </div>
    </div>
    
    <!-- Lotes Vencidos -->
    {% if vencimentos.expired %}
    <h3>Lotes Vencidos ({{ vencimentos.expired_count }})</h3>
    <table>
        <thead>
            <tr>
                <th>Lote</th>
                <th>Medicamento</th>
                <th>Categoria</th>
                <th>Data de Vencimento</th>
                <th>Dias Vencido</th>
                <th>Quantidade</th>
                <th>Urgência</th>
            </tr>
        </thead>
        <tbody>
            {% for item in vencimentos.expired %}
            <tr class="status-expired {% if item.days_expired > 90 %}critical{% elif item.days_expired > 30 %}warning{% endif %}">
                <td class="font-bold">{{ item.batch_number }}</td>
                <td>{{ item.medication_name }}</td>
                <td>{{ item.category }}</td>
                <td class="text-center">{{ item.expiry_date|date:"d/m/Y" }}</td>
                <td class="text-center">{{ item.days_expired }}</td>
                <td class="text-right">{{ item.total_quantity }}</td>
                <td class="text-center">
                    {% if item.days_expired > 90 %}
                        <span class="font-bold">CRÍTICA</span>
                    {% elif item.days_expired > 30 %}
                        <span class="font-bold">ALTA</span>
                    {% else %}
                        MÉDIA
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <h3>Lotes Vencidos</h3>
    <div class="no-data">
        <p>✅ Nenhum lote vencido encontrado.</p>
    </div>
    {% endif %}
    
    <!-- Lotes Próximos ao Vencimento -->
    {% if vencimentos.near_expiry %}
    <div class="page-break"></div>
    <h3>Lotes Próximos ao Vencimento ({{ vencimentos.near_expiry_count }})</h3>
    <table>
        <thead>
            <tr>
                <th>Lote</th>
                <th>Medicamento</th>
                <th>Categoria</th>
                <th>Data de Vencimento</th>
                <th>Dias Restantes</th>
                <th>Quantidade</th>
                <th>Prioridade</th>
            </tr>
        </thead>
        <tbody>
            {% for item in vencimentos.near_expiry %}
            <tr class="status-near-expiry {% if item.days_until_expiry <= 7 %}critical{% elif item.days_until_expiry <= 15 %}warning{% endif %}">
                <td class="font-bold">{{ item.batch_number }}</td>
                <td>{{ item.medication_name }}</td>
                <td>{{ item.category }}</td>
                <td class="text-center">{{ item.expiry_date|date:"d/m/Y" }}</td>
                <td class="text-center">{{ item.days_until_expiry }}</td>
                <td class="text-right">{{ item.total_quantity }}</td>
                <td class="text-center">
                    {% if item.days_until_expiry <= 7 %}
                        <span class="font-bold">ALTA</span>
                    {% elif item.days_until_expiry <= 15 %}
                        <span class="font-bold">MÉDIA</span>
                    {% else %}
                        BAIXA
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <h3>Lotes Próximos ao Vencimento</h3>
    <div class="no-data">
        <p>✅ Nenhum lote próximo ao vencimento encontrado nos próximos 30 dias.</p>
    </div>
    {% endif %}
    
    <!-- Resumo e Recomendações -->
    {% if vencimentos.expired_count > 0 or vencimentos.near_expiry_count > 0 %}
    <div class="page-break"></div>
    <h3>Resumo e Recomendações</h3>
    
    <table>
        <thead>
            <tr>
                <th>Situação</th>
                <th>Quantidade de Lotes</th>
                <th>Quantidade Total</th>
                <th>Ação Recomendada</th>
            </tr>
        </thead>
        <tbody>
            {% if vencimentos.expired_count > 0 %}
            <tr class="status-expired">
                <td class="font-bold">Lotes Vencidos</td>
                <td class="text-right">{{ vencimentos.expired_count }}</td>
                <td class="text-right">{{ vencimentos.total_expired_quantity }}</td>
                <td>
                    <strong>URGENTE:</strong> Remover do estoque, verificar descarte adequado, 
                    investigar causas do vencimento.
                </td>
            </tr>
            {% endif %}
            
            {% if vencimentos.near_expiry_count > 0 %}
            <tr class="status-near-expiry">
                <td class="font-bold">Próximo ao Vencimento</td>
                <td class="text-right">{{ vencimentos.near_expiry_count }}</td>
                <td class="text-right">{{ vencimentos.total_near_expiry_quantity }}</td>
                <td>
                    <strong>ATENÇÃO:</strong> Priorizar dispensação, considerar promoções, 
                    transferir para filiais com maior demanda.
                </td>
            </tr>
            {% endif %}
        </tbody>
    </table>
    
    <!-- Análise por Urgência -->
    <h4>Análise por Urgência</h4>
    <table>
        <thead>
            <tr>
                <th>Urgência</th>
                <th>Critério</th>
                <th>Lotes</th>
                <th>Ação Imediata</th>
            </tr>
        </thead>
        <tbody>
            <tr class="critical">
                <td class="font-bold">CRÍTICA</td>
                <td>Vencidos há mais de 90 dias ou vencem em até 7 dias</td>
                <td class="text-right">
                    {{ vencimentos.critical_count|default:0 }}
                </td>
                <td>Remoção imediata e descarte</td>
            </tr>
            <tr class="warning">
                <td class="font-bold">ALTA</td>
                <td>Vencidos há 30-90 dias ou vencem em 8-15 dias</td>
                <td class="text-right">
                    {{ vencimentos.high_count|default:0 }}
                </td>
                <td>Dispensação prioritária</td>
            </tr>
            <tr>
                <td class="font-bold">MÉDIA/BAIXA</td>
                <td>Outros casos</td>
                <td class="text-right">
                    {{ vencimentos.remaining_count|default:0 }}
                </td>
                <td>Monitoramento contínuo</td>
            </tr>
        </tbody>
    </table>
    {% else %}
    <div class="page-break"></div>
    <h3>✅ Status Excelente</h3>
    <div class="no-data">
        <p><strong>Parabéns!</strong> Não há lotes vencidos ou próximos ao vencimento nos próximos 30 dias.</p>
        <p>Continue monitorando regularmente para manter essa excelente gestão de estoque.</p>
    </div>
    {% endif %}
</body>
</html>
